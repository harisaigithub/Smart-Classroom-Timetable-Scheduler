{% extends 'base_dashboard.html' %}
{% load timetable_extras %}

{% block title %}Weekly Schedule | Smart Scheduler{% endblock %}
{% block header_title %}Timetable Grid View{% endblock %}

{% block content %}
<div class="space-y-6 fade-in-up">

    <!-- FILTER + ACTIONS -->
    <div class="flex flex-wrap justify-between items-center bg-white p-6 rounded-[24px] border border-borderSubtle">

        <div class="flex gap-4">
            <select onchange="location = this.value;"
                    class="bg-bgSoft border border-borderSubtle rounded-xl px-4 py-2 text-xs font-bold text-primary outline-none">

                <option value="?">All Sections</option>

                {% for sec in sections %}
                <option value="?section={{ sec.id }}"
                        {% if selected_section == sec.id|stringformat:"i" %}selected{% endif %}>
                    {{ sec.name }} ({{ sec.department.code }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="flex gap-3">

            {% if selected_section %}
            <a href="{% url 'export_timetable_pdf' selected_section %}"
               class="bg-primary/5 text-primary px-4 py-2 rounded-xl text-xs font-black flex items-center gap-2 hover:bg-primary hover:text-white transition-all">
                <i class="fa-solid fa-file-pdf"></i> Download PDF
            </a>

            <button onclick="window.print();"
                    class="bg-primary/5 text-primary px-4 py-2 rounded-xl text-xs font-black flex items-center gap-2">
                <i class="fa-solid fa-print"></i> Print
            </button>
            {% endif %}

            <form action="{% url 'publish_timetable' %}" method="POST">
                {% csrf_token %}
                <button type="submit"
                        class="bg-secondary text-white px-6 py-2 rounded-xl text-xs font-black btn-glow flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Publish
                </button>
            </form>

        </div>
    </div>


    <!-- GRID TABLE -->
    <div class="bg-white rounded-[32px] border border-borderSubtle overflow-hidden shadow-sm">

        <div class="overflow-x-auto">
            <table class="w-full border-collapse">

                <thead>
                    <tr class="bg-bgSoft border-b border-borderSubtle">
                        <th class="p-6 text-[10px] font-black uppercase text-textGray border-r border-borderSubtle">
                            Time
                        </th>
                        {% for day in days %}
                        <th class="p-6 text-[10px] font-black uppercase text-primary text-center">
                            {{ day|capfirst }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    {% for slot in timeslots %}
                    <tr class="border-b border-borderSubtle">

                        <td class="p-4 bg-bgSoft/50 border-r border-borderSubtle text-center">
                            <span class="text-xs font-black text-textDark">
                                {{ slot.start_time|time:"H:i" }}
                            </span>
                            <span class="block text-[8px] text-textGray font-bold uppercase">
                                to {{ slot.end_time|time:"H:i" }}
                            </span>
                        </td>

                        {% for day in days %}
                        <td class="p-2 min-w-[160px] h-32 relative">

                            {% with key=slot.start_time|time:"H:i" %}
                            {% with entry=grid|get_item:day|get_item:key %}

                                {% if slot.is_break %}
                                    <div class="absolute inset-1 bg-bgSoft rounded-xl border border-dashed border-borderSubtle flex items-center justify-center">
                                        <span class="text-[9px] font-black text-textGray uppercase tracking-widest">
                                            {{ slot.break_name }}
                                        </span>
                                    </div>

                                {% elif entry %}
                                    <div class="h-full p-4 rounded-2xl border border-highlight/30 bg-highlight/5 hover:shadow-lg transition-all">

                                        <p class="text-[10px] font-black text-secondary uppercase mb-1">
                                            {{ entry.subject.code }}
                                        </p>

                                        <h4 class="text-xs font-bold text-primary leading-tight mb-3">
                                            {{ entry.subject.name }}
                                        </h4>

                                        <div class="flex items-center justify-between mt-auto">
                                            <span class="text-[9px] font-bold text-textGray">
                                                {{ entry.classroom.name }}
                                            </span>
                                            <span class="text-[9px] font-bold text-textGray">
                                                {{ entry.faculty.user.email|slice:":1"|upper }}
                                            </span>
                                        </div>

                                    </div>

                                {% else %}
                                    <div class="h-full rounded-2xl border border-dashed border-borderSubtle/30"></div>
                                {% endif %}

                            {% endwith %}
                            {% endwith %}

                        </td>
                        {% endfor %}

                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>

</div>
{% endblock %}
